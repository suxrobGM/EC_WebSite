@page "{articleUrl}"
@model EC_WebSite.Pages.Article.ArticleIndexModel
@{
    ViewData["Title"] = Model.Article.Title;
}

@section SEO {
    <meta name="author" content="@Model.Article.Author" />
    <meta name="description" content="@Model.Article.Summary" />
    <meta name="keywords" content="@Model.Article.Tags" />
    <meta property="og:title" content="@Model.Article.Title" />
    <meta property="og:description" content="@Model.Article.Summary" />
    <meta property="og:site_name" content="Blog" />
    <meta property="og:type" content="article" />
    <meta property="article:published_time" content="@Model.Article.Timestamp" />
    <meta property="article:author" content="@Model.Article.Author" />
    <meta property="article:tags" content="@Model.Article.Tags" />
    <meta name="twitter:title" content="@Model.Article.Title" />
    <meta name="twitter:description" content="@Model.Article.Summary" />
    <meta name="twitter:creator" content="@Model.Article.Author" />
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:site" content="Blog" />
}

<div class="card shadow-sm mb-4">
    <div class="card-header">
        <b>@Model.Article.Title</b>
        <div class="float-right">
            <span class="font-italic">@Model.Article.Timestamp.ToString("MMMM dd, yyyy")</span>
            <span class="mx-3"><i class="fa fa-eye"></i>&nbsp;@Model.Article.ViewCount</span>
            @if (User.HasOneOfTheseRoles(Role.Editor))
            {
                <span class="mx-2">
                    <a asp-page="/Article/Edit" asp-route-id="@Model.Article.Id" data-toggle="tooltip" data-placement="top" title="Edit this article" style="color: black"><i class="fa fa-wrench"></i></a>
                    <a asp-page="/Article/Delete" asp-route-Id="@Model.Article.Id" data-toggle="tooltip" data-placement="top" title="Delete this article" style="color: black"><i class="fa fa-times"></i></a>
                </span>
            }
        </div>
    </div>
    <div class="card-body mb-2 p-2 p-sm-3 p-lg-4">
        @Html.Raw(Model.Article.Content)
    </div>
    <div class="card-footer">
        <b>Tags</b><br />
        @foreach (var tag in Model.ArticleTags)
        {
            <span class="badge badge-dark mr-2">@tag</span>
        }
    </div>
</div>

@if (Model.Article.Comments.Count > 0)
{
    <div id="comments" class="mb-2">
        @foreach (var comment in Model.Comments)
        {
            @if (ViewData["RootCommentId"] == null)
            {
                ViewData.Add("RootCommentId", comment.Id);
            }
            else
            {
                ViewData["RootCommentId"] = comment.Id;
            }

            <partial name="_CommentsPartial" for="@comment" view-data="ViewData" />
        }

        <div id="pagination" class="d-flex">
            <pagination class="mx-auto" page-index="@Model.Comments.PageIndex"
                        total-pages="@Model.Comments.TotalPages"
                        page-method="pageIndex" page-fragment="pagination"
                        base-url="@Model.Article.Url" />
        </div>
    </div>
}


@if (User.Identity.IsAuthenticated)
{
    <div id="comment_textbox" class="card card-header shadow-sm my-4 p-2">
        <label><b>Post a comment</b></label>
        <span asp-validation-for="@Model.CommentText" class="text-danger"></span>
        <form method="post" asp-page-handler="AddComment">
            <div class="bg-white p-2">
                <textarea asp-for="@Model.CommentText" class="comment-editor" rows="4" placeholder="Type message..." required></textarea>
            </div>
            <input type="submit" class="btn btn-sm btn-info shadow-sm mt-2" value="Save comment" />
        </form>
    </div>
}

@section Scripts  {
    <script>
        function collapseElement(targetElement = '') {
            if ($(targetElement).hasClass('show')) {
                $(targetElement).collapse('hide').removeClass('show');
            }
            else {
                $(targetElement).collapse('show').addClass('show');
            }
        }
        function showReplyCommentBox(commentId = '') {
            collapseElement(`#${commentId}.card-footer`);
            $(`button#${commentId}`).hide();
            $(`div#${commentId}.reply-commentbox`).removeClass('d-none');
        }
        function hideReplyCommentBox(commentId = '') {
            $(`button#${commentId}`).show();
            $(`div#${commentId}.reply-commentbox`).addClass('d-none');
        }
    </script>
}