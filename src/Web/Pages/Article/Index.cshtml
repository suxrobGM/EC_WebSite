@page "{slug}"

@model EC_Website.Pages.Article.ArticleIndexModel
@inject ApplicationDbContext Context
@{
    ViewData["Title"] = Model.Entry.Title;
}

@section Head {
    <meta name="author" content="@Model.Entry.Author" />
    <meta name="description" content="@Model.Entry.Summary" />
    <meta name="keywords" content="@Model.ArticleTags" />
    <meta property="og:title" content="@Model.Entry.Title" />
    <meta property="og:description" content="@Model.Entry.Summary" />
    <meta property="og:site_name" content="Blog" />
    <meta property="og:type" content="article" />
    <meta property="article:published_time" content="@Model.Entry.Timestamp" />
    <meta property="article:author" content="@Model.Entry.Author" />
    <meta property="article:tags" content="@Model.ArticleTags" />
    <meta name="twitter:title" content="@Model.Entry.Title" />
    <meta name="twitter:description" content="@Model.Entry.Summary" />
    <meta name="twitter:creator" content="@Model.Entry.Author" />
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:site" content="Blog" />
}

<div class="card shadow-sm mb-4">
    <div class="card-header">
        <b>@Model.Entry.Title</b>
        <div class="float-right">
            <span class="font-italic">@Model.Entry.Timestamp.ToString("MMMM dd, yyyy")</span>
            <span class="mx-2"><i class="fa fa-eye"></i>&nbsp;@Model.Entry.ViewCount</span>
            @{
                var likesCount = Model.Entry.LikedUserNames.Count;
                if (!User.Identity.IsAuthenticated)
                {
                    <a class="mx-2 text-dark text-decoration-none" asp-area="Identity" asp-page="/Account/Login" data-toggle="tooltip" data-placement="top" title="Sign in to like this article">
                        <i class="far fa-heart">&nbsp;@likesCount</i>
                    </a>
                }
                else
                {
                    <button id="like_btn" class="btn btn-sm" data-toggle="tooltip" data-placement="top" title="Like this article">
                        <i class="fas fa-heart">&nbsp;@likesCount</i>
                    </button>
                }
            }
            @if (User.HasMinimumRole(Role.Editor))
            {
                <a class="mx-2" asp-page="./Edit" asp-route-id="@Model.Entry.Id" data-toggle="tooltip" data-placement="top" title="Edit this article" style="color: black"><i class="fa fa-wrench"></i></a>
                <a class="mx-2" asp-page="./Delete" asp-route-Id="@Model.Entry.Id" data-toggle="tooltip" data-placement="top" title="Delete this article" style="color: black"><i class="fa fa-times"></i></a>
            }
        </div>
    </div>
    <div class="card-body mb-2 p-2 p-sm-3 p-lg-4">
        @Html.Raw(Model.Entry.Content)
    </div>
    <div class="card-footer">
        <b>Tags</b><br />
        @foreach (var tag in Model.Entry.Tags)
        {
            <span class="badge badge-dark mr-2">@tag</span>
        }
    </div>
</div>

@if (Model.Entry.Comments.Count > 0)
{
    <div id="comments" class="mb-2">
        @foreach (var comment in Model.Comments)
        {
            @if (ViewData["RootCommentId"] == null)
            {
                ViewData.Add("RootCommentId", comment.Id);
            }
            else
            {
                ViewData["RootCommentId"] = comment.Id;
            }

            <partial name="_CommentsPartial" for="@comment" view-data="ViewData" />
        }

        <div id="pagination" class="d-flex">
            <pagination class="mx-auto" page-index="@Model.Comments.PageIndex"
                        total-pages="@Model.Comments.TotalPages"
                        page-method="pageIndex" page-fragment="pagination"
                        base-url="@Model.Entry.Slug" />
        </div>
    </div>
}


@if (User.Identity.IsAuthenticated)
{
    <div id="comment_textbox" class="card card-header shadow-sm my-4 p-2">
        <label><b>Post a comment</b></label>
        <span asp-validation-for="@Model.CommentContent" class="text-danger"></span>
        <form method="post" asp-page-handler="AddComment">
            <div class="bg-white p-2">
                <textarea asp-for="@Model.CommentContent" class="comment-editor" rows="4" placeholder="Type message..." required></textarea>
            </div>
            <input type="submit" class="btn btn-sm btn-info shadow-sm mt-2" value="Save comment" />
        </form>
    </div>
}

@section Scripts  {
    <script>
        $("#like_btn").click(e => {
            e.preventDefault();

            $.ajax({
                url: "/Article/Ajax?handler=LikeArticle&articleId=@Model.Entry.Id",
                type: "GET",
                success: function(result) {
                    $("#like_btn i").text(` ${result}`);
                }
            });
        });
    </script>
}